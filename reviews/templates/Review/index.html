{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Отзывы о курсе</title>
    {% include 'template/base_head.html' %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="{% static 'review/style.css' %}"/>
</head>
<body onload="check_left_comment()">
{% include 'template/header.html' %}
<center>
    <br>
    <h1 style='margin-top: 25px;'>Отзывы наших учеников</h1>
</center>
<br><br>
{% for review in reviews reversed %}
    <div class="row review-block">
        <div class="col-lg-1 col-md-1 col-sm-1">
        </div>
        <div class="col-lg-8 col-md-8 col-sm-12 review">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label>
                        <strong {% if review.author_id.is_staff %} style="color: red" title='Это представитель Администрации' {% endif %}>
                            {{ review.author_id.get_full_name|default:review.author_id.username }}
                        </strong>&nbsp;&nbsp;
                    </label>
                    <hr>
                </div>
                <div class="panel-body">
                    <div>{{ review.content|safe }}</div>
                </div>
                <div class="panel-body date_review">
                        <label>{{ review.pub_date }}</label>
                </div>
            </div>
        </div>
    </div>
    <br><br>
{% endfor %}
<br>
<hr>
{% if user.is_authenticated %}
    <div class="col-lg-6 col-md-6 col-sm-12 write_review">
        <h3 id="write_comment">Написать отзыв:</h3>
        <form id="comment_form" action="#" method="post">
            {% csrf_token %}
            <textarea cols="40" rows="3" placeholder="Текст отзыва..." name="content" id="content"></textarea>
            <br><br>
            <input type="button" class="btn btn-primary" value="Оставить отзыв" onclick="create_review()"
                   id="review_button"/>
        </form>
    </div>
{% else %}
    <div class="panel panel-warning">
        <div class="panel-heading">
            <h3 id="write_comment">Написать отзыв:</h3>
        </div>
        <div class="panel-body" id="comment_form">
            Только ученики могут оставлять отзывы.<br/>
        </div>
    </div>
{% endif %}
<script>
    var textarea = document.querySelector('textarea');

textarea.addEventListener('keyup', function () {
    if (this.scrollTop > 0) {
        this.style.height = this.scrollHeight + "px";
    }
});

function create_review() {
    $.ajax({
        method: "POST",
        url: "{% url 'review' %}",
        dataType: 'json',
        data: {
            content: document.getElementById('content').value,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        },
        success: function (msgBackFromServer) {
            data = JSON.stringify(msgBackFromServer)
            data = JSON.parse(data)
            alert_if_status(data)
        },
        error: function (msgBackFromServer) {
            data = JSON.stringify(msgBackFromServer)
            data = JSON.parse(data)
            alert_if_status(data)
        }
    })

}

function alert_if_status(data) {
    if (data['success'] === true) {
        document.getElementById('content').textContent = '';
        document.getElementById('content').style = 'display: none;';
        document.getElementById('review_button').style = 'display: none;';
        alert('Вы успешно оставили отзыв!')
        location.reload();
    } else {
        alert(data['error_msg'])
    }
}

function check_left_comment() {
    $.ajax({
        method: "POST",
        url: "{% url 'check_left_review' %}",
        dataType: 'json',
        data: {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        },
        success: function (msgBackFromServer) {
            data = JSON.stringify(msgBackFromServer)
            data = JSON.parse(data)
            if (data['success'] === true) {
                document.getElementById('content').textContent = '';
                document.getElementById('content').style = 'display: none;';
                document.getElementById('review_button').style = 'display: none;';
                document.getElementById('write_comment').style = 'display: none;';
            }
        },
        error: function (msgBackFromServer) {
            data = JSON.stringify(msgBackFromServer)
            data = JSON.parse(data)
            if (data['success'] === true) {
                document.getElementById('content').textContent = '';
                document.getElementById('content').style = 'display: none;';
                document.getElementById('review_button').style = 'display: none;';
                document.getElementById('write_comment').style = 'display: none;';
            }
        }
    })
}
</script>
</body>
</html>